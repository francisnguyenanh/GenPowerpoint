<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GenPowerpoint  AI Slide Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: { colors: { brand: { DEFAULT: '#2563eb', dark: '#1d4ed8', light: '#eff6ff' } } } }
    }
  </script>
  <style>
    .drag-over { border-color: #2563eb !important; background-color: #eff6ff !important; }
    .step-line { flex: 1; height: 2px; background: #e2e8f0; }
    .step-line.done { background: #2563eb; }
    .step-section { transition: opacity .3s ease, transform .3s ease; }
    .step-section.hidden-step { opacity: 0; pointer-events: none; height: 0; overflow: hidden; transform: translateY(8px); }
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner { display: inline-block; width: 1rem; height: 1rem; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin .7s linear infinite; vertical-align: middle; }
    textarea::-webkit-scrollbar { width: 6px; }
    textarea::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 font-sans text-slate-800">

  <!-- Header -->
  <header class="bg-white shadow-sm sticky top-0 z-10">
    <div class="max-w-3xl mx-auto px-4 py-4 flex items-center gap-3">
      <svg class="w-8 h-8 text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="2" y="3" width="20" height="14" rx="2"/>
        <path d="M8 21h8M12 17v4M7 8h5M7 11.5h3"/>
        <rect x="14" y="7" width="4" height="5" rx="1" fill="currentColor" stroke="none"/>
      </svg>
      <div>
        <h1 class="text-lg font-bold text-blue-600 leading-none">GenPowerpoint</h1>
        <p class="text-xs text-slate-400">AI-powered slide generator</p>
      </div>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-4 py-8 space-y-8">

    <!-- STEP 1 -->
    <section id="section1" class="step-section space-y-5">

      <!-- Mode toggle -->
      <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 space-y-3">
        <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">Ch&#7871; &#273;&#7897; t&#7841;o slide</p>
        <div class="grid grid-cols-2 gap-2">
          <button id="modeBuiltinBtn" onclick="setMode('builtin')"
                  class="py-2.5 rounded-xl text-sm font-semibold border transition-colors bg-white text-slate-600 border-slate-200 hover:bg-slate-50">
            &#127912; Master c&oacute; s&#7861;n
          </button>
          <button id="modeManualBtn" onclick="setMode('manual')"
                  class="py-2.5 rounded-xl text-sm font-semibold border transition-colors bg-white text-slate-600 border-slate-200 hover:bg-slate-50">
            &#129302; Import Schema AI
          </button>
        </div>
      </div>

      <!-- Built-in master selector (hidden in other modes) -->
      <div id="builtinSection" class="hidden">
        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-5 space-y-6">
          <div>
            <h2 class="text-base font-semibold text-slate-700">&#127912; Master c&oacute; s&#7861;n</h2>
            <p class="text-xs text-slate-500 mt-1">Quy tr&igrave;nh 4 b&#432;&#7899;c &#273;&#7875; t&#7841;o slide t&#7915; template c&oacute; s&#7861;n.</p>
          </div>

          <!-- Bước 1: Chọn master -->
          <div class="space-y-2">
            <label class="block text-sm font-bold text-blue-700">B&#432;&#7899;c 1: Ch&#7885;n master template</label>
            <div id="builtinMasterList" class="grid grid-cols-1 sm:grid-cols-3 gap-3">
              <p class="text-sm text-slate-400 col-span-3">&#8987; Đang tải danh sách master…</p>
            </div>
            <p id="builtinSelectStatus" class="text-xs text-slate-400 hidden"></p>
          </div>

          <!-- Bước 2: Nhập chủ đề -->
          <div id="bStep2" class="hidden space-y-2 pt-4 border-t border-slate-100">
            <label class="block text-sm font-bold text-blue-700">B&#432;&#7899;c 2: Nh&#7853;p n&#7897;i dung / ch&#7911; &#273;&#7873; b&agrave;i thuy&#7871;t tr&igrave;nh</label>
            <p class="text-xs text-slate-500">Gi&#7899;i thi&#7879;u ng&#7855;n v&#7873; n&#7897;i dung b&#7841;n mu&#7889;n t&#7841;o slide.</p>
            <textarea id="builtinSlideTopic" rows="3"
                      placeholder="V&iacute; d&#7909;: Gi&#7899;i thi&#7879;u s&#7843;n ph&#7849;m X cho kh&aacute;ch h&agrave;ng doanh nghi&#7879;p, t&#7853;p trung v&agrave;o t&iacute;nh n&#259;ng n&#7893;i b&#7853;t v&agrave; l&#7907;i &iacute;ch ROI"
                      class="w-full border border-slate-200 rounded-xl px-3 py-2 text-sm text-slate-700 bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-400 resize-none transition"></textarea>
          </div>

          <!-- Bước 3: Số lượng slide + ngôn ngữ -->
          <div id="bStep3" class="hidden space-y-3 pt-4 border-t border-slate-100">
            <label class="block text-sm font-bold text-blue-700">B&#432;&#7899;c 3: Ch&#7885;n s&#7889; l&#432;&#7907;ng slide v&agrave; ng&ocirc;n ng&#7919;</label>
            <div class="flex gap-3">
              <div class="flex-1">
                <label class="block text-xs font-medium text-slate-500 mb-1">S&#7889; l&#432;&#7907;ng slide</label>
                <input type="number" id="builtinSlideCount" value="7" min="1" max="50"
                       class="w-full border border-slate-200 rounded-xl px-3 py-2 text-sm text-slate-700 bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-400 transition" />
              </div>
              <div class="flex-[2]">
                <label class="block text-xs font-medium text-slate-500 mb-1">Ng&ocirc;n ng&#7919; trong slide</label>
                <select id="builtinSlideLanguage"
                        class="w-full border border-slate-200 rounded-xl px-3 py-2 text-sm text-slate-700 bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-400 transition">
                  <option value="Ti&#7871;ng Vi&#7879;t">&#127987;&#65039; Ti&#7871;ng Vi&#7879;t</option>
                  <option value="English">&#127468;&#127463; English</option>
                  <option value="&#26085;&#26412;&#35486;">&#127471;&#127477; &#26085;&#26412;&#35486;</option>
                  <option value="&#54620;&#44397;&#50612;">&#127472;&#127479; &#54620;&#44397;&#50612;</option>
                  <option value="&#20013;&#25991;&#65288;&#31616;&#20307;&#65289;">&#127464;&#127475; &#20013;&#25991;&#65288;&#31616;&#20307;&#65289;</option>
                  <option value="Fran&ccedil;ais">&#127467;&#127479; Fran&ccedil;ais</option>
                  <option value="Deutsch">&#127465;&#127466; Deutsch</option>
                  <option value="Espa&ntilde;ol">&#127466;&#127480; Espa&ntilde;ol</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Bước 4: Copy prompt -->
          <div id="bStep4" class="hidden space-y-3 pt-4 border-t border-slate-100">
            <label class="block text-sm font-bold text-blue-700">B&#432;&#7899;c 4: Copy prompt for AI gen outline slide</label>
            <p class="text-xs text-slate-500">D&aacute;n prompt v&agrave;o AI (Claude / ChatGPT / Gemini), l&#7845;y JSON outline r&#7891;i d&aacute;n v&agrave;o <strong>B&#432;&#7899;c 5</strong> b&ecirc;n d&#432;&#7899;i.</p>
            <button onclick="copyBuiltinPrompt()"
                    class="w-full py-2.5 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-xl transition-colors flex items-center justify-center gap-2">
              <span id="copyBuiltinPromptBtnText">&#128203; Copy Prompt</span>
            </button>
          </div>

          <!-- Bước 5: Dán outline JSON và tạo slide -->
          <div id="bStep5" class="hidden space-y-2 pt-4 border-t border-slate-100">
            <label class="block text-sm font-bold text-blue-700">B&#432;&#7899;c 5: D&aacute;n outline JSON v&agrave; t&#7841;o slide</label>
            <p class="text-xs text-slate-500">D&aacute;n JSON outline t&#7915; AI v&agrave;o &#273;&acirc;y v&agrave; b&#7845;m t&#7841;o slide.</p>
            <textarea id="builtinOutlineInput" rows="8"
                      placeholder='[ { "layout_index": 0, "title": "...", "placeholders": [...] } ]'
                      class="w-full border border-slate-200 rounded-xl p-3 text-xs font-mono text-slate-700 bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-400 resize-y"></textarea>
            <button id="builtinGenerateBtn" onclick="generateBuiltinPptx()"
                    class="w-full py-3.5 bg-blue-600 hover:bg-blue-700 text-white font-bold text-base rounded-xl transition-colors flex items-center justify-center gap-2 shadow-md">
              <span id="builtinGenerateBtnText">T&#7841;o Slide</span>
            </button>
            <div id="builtinGenerateStatus" class="hidden text-sm rounded-lg px-4 py-3"></div>
            <a id="builtinDownloadLink" href="#" download
               class="hidden w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-xl transition-colors flex items-center justify-center gap-2">
              Download PowerPoint
            </a>
          </div>

        </div>
      </div>

      <!-- Manual Schema Import section -->
      <div id="manualSection" class="hidden">
        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-5 space-y-6">
          <div>
            <h2 class="text-base font-semibold text-slate-700">&#129302; Import Schema t&#7915; AI</h2>
            <p class="text-xs text-slate-500 mt-1">Quy trình 7 bước để tạo template mới và sinh slide tự động.</p>
          </div>

          <!-- Bước 1: PPTX upload -->
          <div id="mStep1" class="space-y-2">
            <label class="block text-sm font-bold text-blue-700">Bước 1: Upload file PPTX</label>
            <div id="manualDropZone"
                 class="border-2 border-dashed border-slate-300 rounded-xl p-6 text-center cursor-pointer transition-colors hover:border-blue-400 hover:bg-blue-50"
                 onclick="document.getElementById('manualPptxFile').click()"
                 ondragover="handleDragOver2(event)"
                 ondragleave="handleDragLeave2()"
                 ondrop="handleDrop2(event)">
              <p class="text-slate-600 font-medium text-sm">Drop file <span class="text-blue-600">.pptx</span> ho&#7863;c click &#273;&#7875; ch&#7885;n</p>
              <input type="file" id="manualPptxFile" accept=".pptx" class="hidden" onchange="handleManualFileSelect(event)" />
            </div>
            <div id="manualFilePill" class="hidden items-center gap-2 bg-blue-50 border border-blue-200 rounded-lg px-4 py-2 mt-2">
              <svg class="w-4 h-4 text-blue-500 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
              <span id="manualFileName" class="text-sm text-blue-700 font-medium truncate flex-1"></span>
              <button onclick="resetManualFile()" class="text-slate-400 hover:text-red-500 text-xs bg-transparent border-0 cursor-pointer p-0">&#x2715;</button>
            </div>
            <button id="manualUploadBtn" onclick="uploadManualPptx()"
                    class="mt-2 w-full py-2.5 bg-blue-600 hover:bg-blue-700 disabled:opacity-40 disabled:cursor-not-allowed text-white font-semibold rounded-xl transition-colors flex items-center justify-center gap-2"
                    disabled>
              <span id="manualUploadBtnText">Upload PPTX</span>
            </button>
            <p id="manualUploadStatus" class="hidden text-xs mt-1"></p>
          </div>

          <!-- Bước 2: Prompt AI -->
          <div id="mStep2" class="hidden space-y-2 pt-4 border-t border-slate-100">
            <div class="flex items-center justify-between">
              <label class="block text-sm font-bold text-blue-700">Bước 2: Copy prompt for AI gen schema</label>
              <div class="flex gap-2">
                <button onclick="savePromptTemplate()"
                        class="text-xs px-2.5 py-1 bg-white border border-slate-200 text-slate-600 rounded-lg hover:bg-slate-50 transition-colors">
                  <span id="savePromptBtnText">&#128190; Lưu template</span>
                </button>
                <button onclick="copySchemaPrompt()"
                        class="text-xs px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors">
                  <span id="copySchemaPromptBtnText">&#128203; Copy Prompt</span>
                </button>
              </div>
            </div>
            <p class="text-xs text-slate-500">Chỉnh sửa prompt nếu cần, sau đó Copy và dán vào AI (Claude / ChatGPT) kèm screenshot slide.</p>
            <textarea id="schemaPromptTextarea" rows="6"
                      class="w-full border border-blue-200 rounded-lg p-2.5 text-xs font-mono text-slate-700 bg-blue-50/30 focus:outline-none focus:ring-2 focus:ring-blue-400 resize-y"></textarea>
          </div>

          <!-- Bước 3: Dán Schema JSON -->
          <div id="mStep3" class="hidden space-y-2 pt-4 border-t border-slate-100">
            <label class="block text-sm font-bold text-blue-700">Bước 3: Dán schema JSON vào ô text area</label>
            <p class="text-xs text-slate-500">Copy JSON schema từ AI trả về và dán vào đây.</p>
            <textarea id="manualSchemaInput" rows="8"
                      placeholder='{ "layouts": [ ... ] }'
                      class="w-full border border-slate-200 rounded-xl p-3 text-xs font-mono text-slate-700 bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-400 resize-y"></textarea>
            <button id="manualImportBtn" onclick="importManualSchema()"
                    class="mt-2 w-full py-2.5 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-xl transition-colors flex items-center justify-center gap-2">
              <span id="manualImportBtnText">&#129302; Import Schema</span>
            </button>
            <p id="manualImportStatus" class="hidden text-xs mt-1"></p>
          </div>

          <!-- Bước 4: Lưu template -->
          <div id="mStep4" class="hidden space-y-3 pt-4 border-t border-slate-100">
            <label class="block text-sm font-bold text-blue-700">Bước 4: Lưu template</label>
            <p class="text-xs text-slate-500">Lưu file JSON và file PPTX vào thư mục builtin_profiles để sử dụng lại sau này.</p>
            <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 space-y-3">
              <div>
                <label class="block text-xs font-medium text-slate-500 mb-1">Tên template <span class="text-red-400">*</span></label>
                <input id="manualBuiltinName" type="text" placeholder="Ví dụ: VTI Corporate Blue"
                       class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-700 bg-white focus:outline-none focus:ring-2 focus:ring-blue-400" />
              </div>
              <div>
                <label class="block text-xs font-medium text-slate-500 mb-1">ID (slug, tự động nếu bỏ trống)</label>
                <input id="manualBuiltinId" type="text" placeholder="Ví dụ: vti-corporate-blue"
                       class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-700 bg-white focus:outline-none focus:ring-2 focus:ring-blue-400 font-mono" />
              </div>
              <button id="saveBuiltinBtn" onclick="saveManualBuiltin()"
                      class="w-full py-2.5 bg-amber-500 hover:bg-amber-600 text-white font-semibold rounded-lg transition-colors flex items-center justify-center gap-2">
                <span id="saveBuiltinBtnText">&#128190; Lưu Template</span>
              </button>
              <p id="saveBuiltinStatus" class="hidden text-xs mt-1"></p>
            </div>
          </div>

          <!-- Bước 5, 6, 7: Tạo slide -->
          <div id="mStep567" class="hidden space-y-6 pt-4 border-t border-slate-100">
            
            <!-- Bước 5 -->
            <div class="space-y-2">
              <label class="block text-sm font-bold text-blue-700">Bước 5: Nhập topic, số slide, ngôn ngữ</label>
              <div>
                <label class="block text-xs font-medium text-slate-500 mb-1">Nội dung / Chủ đề <span class="text-red-400">*</span></label>
                <textarea id="manualSlideTopic" rows="2"
                          placeholder="Ví dụ: Giới thiệu sản phẩm X..."
                          class="w-full border border-slate-200 rounded-xl px-3 py-2 text-sm text-slate-700 bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-400 resize-none"></textarea>
              </div>
              <div class="flex gap-3">
                <div class="flex-1">
                  <label class="block text-xs font-medium text-slate-500 mb-1">Số lượng slide</label>
                  <input type="number" id="manualSlideCount" value="7" min="1" max="50"
                         class="w-full border border-slate-200 rounded-xl px-3 py-2 text-sm text-slate-700 bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-400" />
                </div>
                <div class="flex-[2]">
                  <label class="block text-xs font-medium text-slate-500 mb-1">Ngôn ngữ</label>
                  <select id="manualSlideLanguage"
                          class="w-full border border-slate-200 rounded-xl px-3 py-2 text-sm text-slate-700 bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <option value="Tiếng Việt">🇻🇳 Tiếng Việt</option>
                    <option value="English">🇬🇧 English</option>
                    <option value="日本語">🇯🇵 日本語</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Bước 6 -->
            <div class="space-y-2">
              <label class="block text-sm font-bold text-blue-700">Bước 6: Copy prompt for AI gen outline slide</label>
              <button onclick="copyManualOutlinePrompt()"
                      class="w-full py-2.5 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-xl transition-colors flex items-center justify-center gap-2">
                <span id="manualCopyOutlineBtnText">&#128203; Copy Prompt Tạo Outline</span>
              </button>
            </div>

            <!-- Bước 7 -->
            <div class="space-y-2">
              <label class="block text-sm font-bold text-blue-700">Bước 7: Dán outline JSON và tạo slide</label>
              <p class="text-xs text-slate-500">Dán JSON outline từ AI vào đây và bấm tạo slide.</p>
              <textarea id="manualOutlineInput" rows="8"
                        placeholder='[ { "layout_index": 0, "title": "...", "placeholders": [...] } ]'
                        class="w-full border border-slate-200 rounded-xl p-3 text-xs font-mono text-slate-700 bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-400 resize-y"></textarea>
              <button id="manualGenerateBtn" onclick="generateManualPptx()"
                      class="w-full py-3.5 bg-blue-600 hover:bg-blue-700 text-white font-bold text-base rounded-xl transition-colors flex items-center justify-center gap-2 shadow-md">
                <span id="manualGenerateBtnText">Tạo Slide</span>
              </button>
              <div id="manualGenerateStatus" class="hidden text-sm rounded-lg px-4 py-3"></div>
              <a id="manualDownloadLink" href="#" download
                 class="hidden w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-xl transition-colors flex items-center justify-center gap-2">
                Download PowerPoint
              </a>
            </div>

          </div>
        </div>
      </div>

      <!-- End of sections -->
    </section>

  </main>

  <!-- Toast -->
  <div id="toast"
       class="fixed bottom-6 right-6 bg-slate-800 text-white text-sm font-medium px-5 py-3 rounded-xl shadow-xl opacity-0 pointer-events-none transition-opacity duration-300 flex items-center gap-2 z-50">
    <span id="toastIcon">&#10003;</span>
    <span id="toastMsg"></span>
  </div>

  <script>
    /*  State  */
    let layoutData = null;
    let uploadedFilename = "";
    let selectedBuiltinId = null;
    let builtinLayoutSchema = null;
    let schemaPromptTemplate = "";  // raw template with {filename} placeholder
    let manualUploadedFilename = "";  // pptx uploaded in manual mode

    /*  Toast  */
    let toastTimer;
    function showToast(msg, icon, duration) {
      icon = icon || '\u2713';
      duration = duration || 2800;
      const t = document.getElementById('toast');
      document.getElementById('toastMsg').textContent  = msg;
      document.getElementById('toastIcon').textContent = icon;
      t.style.opacity = '1';
      t.style.pointerEvents = 'auto';
      clearTimeout(toastTimer);
      toastTimer = setTimeout(function() { t.style.opacity = '0'; t.style.pointerEvents = 'none'; }, duration);
    }

    function escapeHtml(str) {
      return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    /*  Built-in Step 5  */
    function showBuiltinStep5() {
      document.getElementById('bStep5').classList.remove('hidden');
      document.getElementById('builtinOutlineInput').focus();
    }

    async function generateBuiltinPptx() {
      var raw = document.getElementById('builtinOutlineInput').value.trim();
      var status = document.getElementById('builtinGenerateStatus');
      var dl = document.getElementById('builtinDownloadLink');
      var btn = document.getElementById('builtinGenerateBtn');

      if (!raw) {
        status.textContent = '\u26a0 Vui lòng dán JSON outline trước khi tạo slide.';
        status.className = 'text-sm rounded-lg px-4 py-3 bg-amber-50 text-amber-700 border border-amber-200';
        status.classList.remove('hidden');
        return;
      }

      var cleaned = raw.replace(/^```[a-z]*\n?/i, '').replace(/```\s*$/, '').trim();
      var parsed;
      try {
        parsed = JSON.parse(cleaned);
        if (!Array.isArray(parsed)) throw new Error('Expected a JSON array.');
      } catch (err) {
        status.textContent = '\u2715 JSON không hợp lệ: ' + err.message;
        status.className = 'text-sm rounded-lg px-4 py-3 bg-red-50 text-red-700 border border-red-200';
        status.classList.remove('hidden');
        return;
      }

      btn.disabled = true;
      document.getElementById('builtinGenerateBtnText').innerHTML = '<span class="spinner"></span>&nbsp;Đang tạo slide\u2026';
      status.classList.remove('hidden');
      status.className = 'text-sm rounded-lg px-4 py-3 bg-blue-50 text-blue-700 border border-blue-100';
      status.textContent = 'Đang gửi dữ liệu lên server\u2026';
      dl.classList.add('hidden');

      try {
        var payload = { slides: parsed, builtin_id: selectedBuiltinId };
        var res = await fetch('/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (res.ok) {
          var blob = await res.blob();
          var url = URL.createObjectURL(blob);
          var cd = res.headers.get('Content-Disposition') || '';
          var match = cd.match(/filename="?([^"]+)"?/);
          var name = match ? match[1] : 'presentation.pptx';
          dl.href = url; dl.download = name; dl.classList.remove('hidden');
          status.textContent = '\u2714 Tạo slide thành công!';
          status.className = 'text-sm rounded-lg px-4 py-3 bg-emerald-50 text-emerald-700 border border-emerald-200';
          showToast('Thành công! Bấm Download để tải file.', '\uD83C\uDF89', 4000);
        } else {
          var data = await res.json().catch(function() { return { error: 'Lỗi không xác định.' }; });
          status.textContent = '\u2715 ' + (data.error || 'Tạo slide thất bại.');
          status.className = 'text-sm rounded-lg px-4 py-3 bg-red-50 text-red-700 border border-red-200';
        }
      } catch (err) {
        status.textContent = 'Lỗi mạng: ' + err.message;
        status.className = 'text-sm rounded-lg px-4 py-3 bg-red-50 text-red-700 border border-red-200';
      } finally {
        btn.disabled = false;
        document.getElementById('builtinGenerateBtnText').textContent = 'Tạo lại Slide';
      }
    }

    /* ════════════════════════════════════════════════════════════════
       Mode switching (master vs built-in profile)
    ════════════════════════════════════════════════════════════════ */
    function setMode(mode) {
      selectedBuiltinId = null;
      var builtinSection = document.getElementById('builtinSection');
      var manualSection  = document.getElementById('manualSection');
      var btnBuiltin     = document.getElementById('modeBuiltinBtn');
      var btnManual      = document.getElementById('modeManualBtn');
      var activeClass    = 'py-2.5 rounded-xl text-sm font-semibold border transition-colors bg-blue-600 text-white border-blue-600';
      var inactiveClass  = 'py-2.5 rounded-xl text-sm font-semibold border transition-colors bg-white text-slate-600 border-slate-200 hover:bg-slate-50';

      // Reset all
      builtinSection.classList.add('hidden');
      manualSection.classList.add('hidden');
      btnBuiltin.className = inactiveClass;
      btnManual.className  = inactiveClass;

      if (mode === 'builtin') {
        builtinSection.classList.remove('hidden');
        btnBuiltin.className = activeClass;
        ['bStep2','bStep3','bStep4','bStep5'].forEach(function(id){
          document.getElementById(id).classList.add('hidden');
        });
        selectedBuiltinId = null;
        loadBuiltinMasters();
      } else if (mode === 'manual') {
        manualSection.classList.remove('hidden');
        btnManual.className = activeClass;
        loadPromptTemplate();
      }
    }

    /* ════════════════════════════════════════════════════════════════
       Manual Schema Import
    ════════════════════════════════════════════════════════════════ */

    /* Prompt template helpers */
    async function loadPromptTemplate() {
      try {
        var res = await fetch('/prompt_template');
        if (!res.ok) return;
        var data = await res.json();
        schemaPromptTemplate = data.template || '';
        var fname = manualUploadedFilename || '{filename}';
        document.getElementById('schemaPromptTextarea').value =
          schemaPromptTemplate.replace(/\{filename\}/g, fname);
      } catch (e) {}
    }

    function injectFilenameIntoPrompt(fname) {
      var ta = document.getElementById('schemaPromptTextarea');
      if (ta && ta.value) {
        ta.value = ta.value.replace(/\{filename\}/g, fname);
      }
    }

    async function copySchemaPrompt() {
      var promptText = document.getElementById('schemaPromptTextarea').value;
      if (!promptText.trim()) { showToast('Prompt đang trống!', '\u26a0', 2000); return; }
      var btn = document.getElementById('copySchemaPromptBtnText');
      btn.innerHTML = '<span class="spinner"></span>&nbsp;Đang tải inventory…';

      var inventoryText = '';
      if (manualUploadedFilename) {
        try {
          var res = await fetch('/export_inventory/' + encodeURIComponent(manualUploadedFilename));
          if (res.ok) {
            inventoryText = await res.text();
          }
        } catch (e) { /* ignore — copy prompt without inventory */ }
      }

      var combined;
      if (inventoryText && promptText.includes('{inventory}')) {
        combined = promptText.replace(/\{inventory\}/g, inventoryText);
      } else if (inventoryText) {
        combined = promptText + '\n\n' + '='.repeat(65) + '\nLAYOUT INVENTORY (auto-extracted from PPTX)\n' + '='.repeat(65) + '\n' + inventoryText;
      } else {
        combined = promptText.replace(/\{inventory\}/g, '(inventory not available)');
      }

      function onCopied(withInventory) {
        btn.textContent = '\u2714 Đã copy!';
        var msg = withInventory
          ? 'Prompt + inventory đã được copy! (' + inventoryText.split('\n').length + ' dòng)'
          : 'Prompt đã được copy! (không tìm thấy inventory)';
        showToast(msg, '\uD83D\uDCCB', 3000);
        setTimeout(function() { btn.textContent = '\uD83D\uDCCB Copy Prompt'; }, 2500);
      }
      if (navigator.clipboard) {
        navigator.clipboard.writeText(combined).then(function() { onCopied(!!inventoryText); });
      } else {
        var ta = document.createElement('textarea');
        ta.value = combined; ta.style.position = 'fixed'; ta.style.opacity = '0';
        document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
        onCopied(!!inventoryText);
      }
    }

    async function savePromptTemplate() {
      var text = document.getElementById('schemaPromptTextarea').value;
      if (!text.trim()) return;
      var btn = document.getElementById('savePromptBtnText');
      var orig = btn.textContent;
      btn.textContent = 'Đang lưu…';
      try {
        var res = await fetch('/save_prompt_template', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ template: text })
        });
        if (res.ok) {
          schemaPromptTemplate = text;
          btn.textContent = '\u2714 Đã lưu!';
          showToast('Đã lưu template prompt!', '\u2714', 2000);
        } else {
          btn.textContent = '\u2715 Lỗi';
        }
      } catch (e) {
        btn.textContent = '\u2715 Lỗi mạng';
      }
      setTimeout(function() { btn.textContent = orig; }, 2500);
    }

    function handleDragOver2(e) { e.preventDefault(); document.getElementById('manualDropZone').classList.add('drag-over'); }
    function handleDragLeave2()  { document.getElementById('manualDropZone').classList.remove('drag-over'); }
    function handleDrop2(e) {
      e.preventDefault();
      document.getElementById('manualDropZone').classList.remove('drag-over');
      var file = e.dataTransfer.files[0];
      if (file) applyManualFile(file);
    }
    function handleManualFileSelect(e) { var file = e.target.files[0]; if (file) applyManualFile(file); }
    function applyManualFile(file) {
      if (!file.name.toLowerCase().endsWith('.pptx')) { showToast('Chỉ hỗ trợ file .pptx.', '✕'); return; }
      document.getElementById('manualFileName').textContent = file.name;
      document.getElementById('manualFilePill').classList.remove('hidden');
      document.getElementById('manualFilePill').classList.add('flex');
      document.getElementById('manualUploadBtn').disabled = false;
      var dt = new DataTransfer();
      dt.items.add(file);
      document.getElementById('manualPptxFile').files = dt.files;
    }
    function resetManualFile() {
      document.getElementById('manualPptxFile').value = '';
      document.getElementById('manualFilePill').classList.add('hidden');
      document.getElementById('manualFilePill').classList.remove('flex');
      document.getElementById('manualUploadBtn').disabled = true;
      document.getElementById('mStep2').classList.add('hidden');
      document.getElementById('mStep3').classList.add('hidden');
      document.getElementById('mStep4').classList.add('hidden');
      document.getElementById('mStep567').classList.add('hidden');
      manualUploadedFilename = '';
    }
    function toggleBuiltinFields() {
      var checked = document.getElementById('manualSaveBuiltin').checked;
      document.getElementById('builtinFields').classList.toggle('hidden', !checked);
    }

    function downloadInventory() {
      if (!manualUploadedFilename) {
        showToast('Vui lòng upload file PPTX trước.', '⚠', 3000);
        return;
      }
      var link = document.createElement('a');
      link.href = '/export_inventory/' + encodeURIComponent(manualUploadedFilename);
      link.download = '';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    async function uploadManualPptx() {
      var input  = document.getElementById('manualPptxFile');
      var btn    = document.getElementById('manualUploadBtn');
      var status = document.getElementById('manualUploadStatus');
      if (!input.files.length) return;
      var formData = new FormData();
      formData.append('file', input.files[0]);
      btn.disabled = true;
      document.getElementById('manualUploadBtnText').innerHTML = '<span class="spinner"></span>&nbsp;Uploading…';
      status.classList.remove('hidden');
      status.className = 'text-xs mt-1 text-slate-400';
      status.textContent = 'Uploading…';
      try {
        var res  = await fetch('/upload_master', { method: 'POST', body: formData });
        var text = await res.text();
        var data;
        try { data = JSON.parse(text); }
        catch (parseErr) {
          // Server returned HTML (e.g. 500 error page) — show the raw status
          status.textContent = '✕ Server lỗi (HTTP ' + res.status + '). Kiểm tra console để biết thêm.';
          status.className = 'text-xs mt-1 text-red-500';
          console.error('Server response was not JSON:\n', text.substring(0, 1000));
          return;
        }
        if (!res.ok) {
          status.textContent = '✕ ' + (data.error || 'Upload thất bại.');
          status.className = 'text-xs mt-1 text-red-500';
          return;
        }
        manualUploadedFilename = data.filename;
        status.textContent = '✔ Đã upload: ' + data.filename + ' (' + data.total_layouts + ' layouts detected)';
        status.className = 'text-xs mt-1 text-emerald-600';
        injectFilenameIntoPrompt(data.filename);
        document.getElementById('mStep2').classList.remove('hidden');
        document.getElementById('mStep3').classList.remove('hidden');
        document.getElementById('mStep2').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        showToast('Upload thành công! Copy prompt ở bước 2 và gửi cho AI.', '✔');
      } catch (err) {
        status.textContent = 'Lỗi mạng: ' + err.message;
        status.className = 'text-xs mt-1 text-red-500';
      } finally {
        btn.disabled = false;
        document.getElementById('manualUploadBtnText').textContent = 'Upload PPTX';
      }
    }

    async function importManualSchema() {
      if (!manualUploadedFilename) {
        showToast('Vui lòng upload file PPTX trước.', '⚠', 3000); return;
      }
      var rawSchema = document.getElementById('manualSchemaInput').value.trim();
      if (!rawSchema) {
        showToast('Vui lòng dán schema JSON vào ô text.', '⚠', 3000); return;
      }
      // Strip markdown code fences if AI wrapped the JSON (e.g. ```json ... ```)
      rawSchema = rawSchema.replace(/^```[a-zA-Z]*\s*/,'').replace(/\s*```\s*$/,'').trim();
      var parsedSchema;
      try {
        parsedSchema = JSON.parse(rawSchema);
        if (!parsedSchema.layouts) throw new Error('Schema phải có trường "layouts".');
      } catch (err) {
        showToast('JSON không hợp lệ: ' + err.message, '✕', 4000); return;
      }

      var btn    = document.getElementById('manualImportBtn');
      var status = document.getElementById('manualImportStatus');
      btn.disabled = true;
      document.getElementById('manualImportBtnText').innerHTML = '<span class="spinner"></span>&nbsp;Đang import…';
      status.classList.remove('hidden');
      status.className = 'text-xs mt-1 text-slate-400';
      status.textContent = 'Đang lưu schema…';

      try {
        // Step 1: import_schema
        var res  = await fetch('/import_schema', {
          method:  'POST',
          headers: { 'Content-Type': 'application/json' },
          body:    JSON.stringify({ filename: manualUploadedFilename, schema: parsedSchema })
        });
        var merged = await res.json();
        if (!res.ok) {
          status.textContent = '✕ ' + (merged.error || 'Import thất bại.');
          status.className = 'text-xs mt-1 text-red-500';
          return;
        }

        // Update app state
        layoutData = merged.layouts;
        uploadedFilename = manualUploadedFilename;

        status.textContent = '✔ Import thành công! ' + layoutData.length + ' layouts.';
        status.className = 'text-xs mt-1 text-emerald-600';
        showToast('Schema đã import! Tiếp tục bước 4-7 bên dưới.', '✔');

        // Reveal steps 4 and 5-7
        document.getElementById('mStep4').classList.remove('hidden');
        document.getElementById('mStep567').classList.remove('hidden');
        document.getElementById('mStep4').scrollIntoView({ behavior: 'smooth', block: 'nearest' });

      } catch (err) {
        status.textContent = 'Lỗi mạng: ' + err.message;
        status.className = 'text-xs mt-1 text-red-500';
      } finally {
        btn.disabled = false;
        document.getElementById('manualImportBtnText').textContent = '\u{1F916} Import Schema';
      }
    }

    async function saveManualBuiltin() {
      var bName = (document.getElementById('manualBuiltinName').value || '').trim();
      var bId   = (document.getElementById('manualBuiltinId').value   || '').trim();
      if (!bName) { showToast('Vui lòng nhập tên template.', '\u26a0', 3000); return; }
      if (!manualUploadedFilename) { showToast('Không tìm thấy file PPTX đã upload.', '\u26a0', 3000); return; }
      var btn = document.getElementById('saveBuiltinBtn');
      var btnText = document.getElementById('saveBuiltinBtnText');
      var statusEl = document.getElementById('saveBuiltinStatus');
      btn.disabled = true;
      btnText.innerHTML = '<span class="spinner"></span>&nbsp;Đang lưu\u2026';
      try {
        var schemaRes = await fetch('/schema/' + encodeURIComponent(manualUploadedFilename));
        if (!schemaRes.ok) throw new Error('Không tìm thấy schema đã import.');
        var schema = await schemaRes.json();
        var res = await fetch('/save_as_builtin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filename: manualUploadedFilename, builtin_id: bId || null, builtin_name: bName, schema: schema })
        });
        var result = await res.json();
        if (!res.ok) {
          statusEl.textContent = '\u2715 ' + (result.error || 'Lưu thất bại.');
          statusEl.className = 'text-xs mt-1 text-red-500';
        } else {
          statusEl.textContent = '\u2714 Đã lưu template "' + result.builtin_name + '" (id: ' + result.builtin_id + ')';
          statusEl.className = 'text-xs mt-1 text-emerald-600';
          showToast('Template đã lưu vào thư viện!', '\uD83C\uDF89', 3500);
        }
        statusEl.classList.remove('hidden');
      } catch(e) {
        statusEl.textContent = 'Lỗi: ' + e.message;
        statusEl.className = 'text-xs mt-1 text-red-500';
        statusEl.classList.remove('hidden');
      } finally {
        btn.disabled = false;
        btnText.textContent = '\u{1F4BE} Lưu Template';
      }
    }

    async function copyManualOutlinePrompt() {
      if (!layoutData || !layoutData.length) {
        showToast('Schema chưa được import.', '\u26a0', 3000); return;
      }
      var topic = (document.getElementById('manualSlideTopic').value || '').trim();
      if (!topic) {
        document.getElementById('manualSlideTopic').focus();
        showToast('Nhập chủ đề bài thuyết trình trước.', '\u26a0', 3000); return;
      }
      var count = document.getElementById('manualSlideCount').value || '7';
      var language = document.getElementById('manualSlideLanguage').value || 'Ti\u1EBFng Vi\u1EC7t';
      var prompt = buildAIPrompt(topic, count, language);
      if (!prompt) return;
      var btnText = document.getElementById('manualCopyOutlineBtnText');
      function onCopied() {
        btnText.textContent = '\u2714 Đã copy!';
        showToast('Prompt outline đã copy! Dán vào AI để tạo slide.', '\uD83D\uDCCB', 3000);
        setTimeout(function() { btnText.textContent = '\uD83D\uDCCB Copy Prompt Tạo Outline'; }, 2500);
      }
      if (navigator.clipboard) {
        navigator.clipboard.writeText(prompt).then(onCopied);
      } else {
        var ta = document.createElement('textarea');
        ta.value = prompt; ta.style.position = 'fixed'; ta.style.opacity = '0';
        document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
        onCopied();
      }
    }

    async function generateManualPptx() {
      var raw = document.getElementById('manualOutlineInput').value.trim();
      var status = document.getElementById('manualGenerateStatus');
      var dl = document.getElementById('manualDownloadLink');
      var btn = document.getElementById('manualGenerateBtn');
      var btnText = document.getElementById('manualGenerateBtnText');

      if (!raw) {
        showToast('Vui lòng dán JSON outline từ AI.', '⚠', 3000);
        return;
      }

      var cleaned = raw.replace(/^```[a-z]*\n?/i, '').replace(/```\s*$/, '').trim();
      var parsed;
      try {
        parsed = JSON.parse(cleaned);
        if (!Array.isArray(parsed)) throw new Error('Expected a JSON array.');
      } catch (err) {
        status.textContent = '✕ Invalid JSON: ' + err.message;
        status.className = 'text-sm rounded-lg px-4 py-3 bg-red-50 text-red-700 border border-red-200';
        status.classList.remove('hidden');
        return;
      }

      btn.disabled = true;
      btnText.innerHTML = '<span class="spinner"></span>&nbsp;Đang tạo slide…';
      status.classList.remove('hidden');
      status.className = 'text-sm rounded-lg px-4 py-3 bg-blue-50 text-blue-700 border border-blue-100';
      status.textContent = 'Đang gửi yêu cầu lên server…';
      dl.classList.add('hidden');

      try {
        var payload = { slides: parsed, filename: manualUploadedFilename };
        var res = await fetch('/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (res.ok) {
          var blob = await res.blob();
          var url = URL.createObjectURL(blob);
          var cd = res.headers.get('Content-Disposition') || '';
          var match = cd.match(/filename="?([^"]+)"?/);
          var name = match ? match[1] : 'presentation.pptx';
          dl.href = url; dl.download = name; dl.classList.remove('hidden');
          status.textContent = '✔ Tạo slide thành công!';
          status.className = 'text-sm rounded-lg px-4 py-3 bg-emerald-50 text-emerald-700 border border-emerald-200';
          showToast('Tạo slide thành công! Bấm Download để tải về.', '🎉', 4000);
        } else {
          var data = await res.json().catch(function() { return { error: 'Unknown error.' }; });
          status.textContent = '✕ ' + (data.error || 'Tạo slide thất bại.');
          status.className = 'text-sm rounded-lg px-4 py-3 bg-red-50 text-red-700 border border-red-200';
        }
      } catch (err) {
        status.textContent = 'Lỗi mạng: ' + err.message;
        status.className = 'text-sm rounded-lg px-4 py-3 bg-red-50 text-red-700 border border-red-200';
      } finally {
        btn.disabled = false;
        btnText.textContent = 'Tạo Slide';
      }
    }

    function buildAIPrompt(topic, count, language) {
      var layoutJson = JSON.stringify(layoutData, null, 2);
      return 'You are a PowerPoint slide content generator.\n\n' +
        '== PRESENTATION REQUIREMENTS ==\n' +
        'Topic / Content   : ' + topic + '\n' +
        'Number of slides  : ' + count + '\n' +
        'Slide language    : ' + language + '\n\n' +
        '== MASTER LAYOUT STRUCTURE ==\n' +
        'Below is the layout structure extracted from the PowerPoint Master file.\n' +
        'Each layout has an index, a name, and placeholders (idx, name, type).\n' +
        layoutJson + '\n\n' +
        '== YOUR TASK ==\n' +
        'Generate exactly ' + count + ' slides about the topic above.\n' +
        'All text content MUST be written in: ' + language + '.\n\n' +
        'Strict rules:\n' +
        '1. Return ONLY a valid JSON array — no markdown, no explanation, no code fences.\n' +
        '2. The array must contain exactly ' + count + ' slide objects.\n' +
        '3. Each slide object must have:\n' +
        '   - "layout_index": (integer) index of the layout to use\n' +
        '   - "title": short slide title (string)\n' +
        '   - "placeholders": array of objects, each with:\n' +
        '       { "id": <placeholder idx as integer>, "content": <string or string[]>, "type": "text" | "list" }\n' +
        '4. For bullet-point content use type "list" with content as a string array.\n' +
        '5. For plain text use type "text" with content as a string.\n' +
        '6. Choose layouts intelligently (e.g., layout 0 for title slide, others for content).\n\n' +
        '== EXAMPLE OUTPUT (2 slides) ==\n' +
        '[\n' +
        '  {\n' +
        '    "layout_index": 0,\n' +
        '    "title": "Tiêu đề bài thuyết trình",\n' +
        '    "placeholders": [\n' +
        '      { "id": 0, "content": "Tiêu đề bài thuyết trình", "type": "text" },\n' +
        '      { "id": 1, "content": "Tên tác giả • Ngày tháng", "type": "text" }\n' +
        '    ]\n' +
        '  },\n' +
        '  {\n' +
        '    "layout_index": 1,\n' +
        '    "title": "Nội dung chính",\n' +
        '    "placeholders": [\n' +
        '      { "id": 0, "content": "Nội dung chính", "type": "text" },\n' +
        '      { "id": 1, "content": ["Điểm 1", "Điểm 2", "Điểm 3"], "type": "list" }\n' +
        '    ]\n' +
        '  }\n' +
        ']\n\n' +
        'Now generate all ' + count + ' slides in ' + language + '. Return ONLY the JSON array.';
    }

    async function copyBuiltinPrompt() {
      if (!layoutData || !layoutData.length) {
        showToast('Vui lòng chọn master template trước.', '\u26a0', 3000); return;
      }
      var topic = (document.getElementById('builtinSlideTopic').value || '').trim();
      if (!topic) {
        document.getElementById('builtinSlideTopic').focus();
        showToast('Nhập chủ đề bài thuyết trình trước.', '\u26a0', 3000); return;
      }
      var count = document.getElementById('builtinSlideCount').value || '7';
      var language = document.getElementById('builtinSlideLanguage').value || 'Ti\u1EBFng Vi\u1EC7t';
      var prompt = buildAIPrompt(topic, count, language);
      if (!prompt) return;
      var btnText = document.getElementById('copyBuiltinPromptBtnText');
      function onCopied() {
        btnText.textContent = '\u2714 Đã copy!';
        showToast('Prompt đã copy! Dán vào AI để tạo outline slide.', '\uD83D\uDCCB', 3000);
        setTimeout(function() { btnText.textContent = '\uD83D\uDCCB Copy Prompt'; }, 2500);
      }
      if (navigator.clipboard) {
        navigator.clipboard.writeText(prompt).then(onCopied);
      } else {
        var ta = document.createElement('textarea');
        ta.value = prompt; ta.style.position = 'fixed'; ta.style.opacity = '0';
        document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
        onCopied();
      }
    }

    async function deleteBuiltinMaster(id, name) {
      if (!confirm('Xoá template "' + name + '"?\nFile JSON profile và PPTX trong master_slide/ sẽ bị xoá.')) return;
      try {
        var res = await fetch('/delete_builtin/' + encodeURIComponent(id), { method: 'DELETE' });
        var data = await res.json();
        if (!res.ok) { showToast('Lỗi: ' + (data.error || 'Xoá thất bại'), '\u2715', 4000); return; }
        showToast('Đã xoá template "' + name + '"', '\uD83D\uDDD1', 2500);
        loadBuiltinMasters();
      } catch(e) {
        showToast('Lỗi mạng: ' + e.message, '\u2715', 4000);
      }
    }

    /* ────────────────────────────────────────────────────────────
       Built-in master selector
    ──────────────────────────────────────────────────────────── */
    async function loadBuiltinMasters() {
      var list = document.getElementById('builtinMasterList');
      list.innerHTML = '<p class="text-sm text-slate-400 col-span-3">&#8987; Đang tải…</p>';
      try {
        var res  = await fetch('/list_builtin_masters');
        var data = await res.json();
        var masters = data.masters || [];
        if (masters.length === 0) {
          list.innerHTML = '<p class="text-sm text-slate-400 col-span-3">Không có master nào trong thư mục master_slide/.</p>';
          return;
        }
        list.innerHTML = '';
        masters.forEach(function(m) {
          var card = document.createElement('div');
          card.id = 'builtinCard_' + m.id;
          card.className = 'relative cursor-pointer rounded-xl border-2 border-slate-200 p-4 hover:border-blue-400 hover:shadow-md transition-all space-y-2';
          card.onclick = function() { selectBuiltinMaster(m); };

          // Color swatches
          var swatchRow = document.createElement('div');
          swatchRow.className = 'flex gap-1 mb-1';
          var palette = m.color_palette || {};
          var swatchColors = [palette.primary, palette.text_main, palette.background_alt, palette.accent2, palette.accent3].filter(Boolean).slice(0, 5);
          swatchColors.forEach(function(c) {
            var s = document.createElement('span');
            s.style.cssText = 'display:inline-block;width:14px;height:14px;border-radius:50%;background:' + c + ';border:1px solid rgba(0,0,0,.1)';
            swatchRow.appendChild(s);
          });

          var nameEl = document.createElement('p');
          nameEl.className = 'text-sm font-semibold text-slate-800 truncate';
          nameEl.textContent = m.name || m.id;

          var meta = document.createElement('p');
          meta.className = 'text-xs text-slate-400';
          var fontName = (m.theme_fonts || {}).major_latin || '—';
          meta.textContent = m.total_layouts + ' layouts · ' + fontName;

          var badge = document.createElement('span');
          badge.id = 'builtinBadge_' + m.id;
          badge.className = 'hidden absolute top-2 right-2 bg-blue-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full';
          badge.textContent = '✓ Selected';

          card.appendChild(swatchRow);
          card.appendChild(nameEl);
          card.appendChild(meta);
          card.appendChild(badge);
          var delBtn = document.createElement('button');
          delBtn.className = 'mt-2 w-full py-1 text-xs font-medium bg-red-50 hover:bg-red-100 text-red-500 hover:text-red-700 border border-red-200 rounded-lg transition-colors';
          delBtn.textContent = '\uD83D\uDDD1 Xoá template';
          (function(mid, mname) {
            delBtn.onclick = function(e) { e.stopPropagation(); deleteBuiltinMaster(mid, mname); };
          })(m.id, m.name || m.id);
          card.appendChild(delBtn);
          list.appendChild(card);
        });
      } catch (err) {
        list.innerHTML = '<p class="text-sm text-red-500 col-span-3">Lỗi: ' + escapeHtml(err.message) + '</p>';
      }
    }

    async function selectBuiltinMaster(m) {
      // Deselect all cards
      document.querySelectorAll('[id^="builtinCard_"]').forEach(function(c) {
        c.className = c.className.replace(/border-blue-[0-9]+/g, 'border-slate-200').replace('bg-blue-50', '');
      });
      document.querySelectorAll('[id^="builtinBadge_"]').forEach(function(b) { b.classList.add('hidden'); });

      // Highlight selected
      var card  = document.getElementById('builtinCard_'  + m.id);
      var badge = document.getElementById('builtinBadge_' + m.id);
      if (card)  card.className  = card.className.replace('border-slate-200', 'border-blue-500') + ' bg-blue-50';
      if (badge) badge.classList.remove('hidden');

      selectedBuiltinId = m.id;
      uploadedFilename  = '__builtin__';

      var statusEl = document.getElementById('builtinSelectStatus');
      statusEl.textContent = '&#8987; Đang tải layout schema cho ' + m.name + '…';
      statusEl.classList.remove('hidden');
      try {
        var res  = await fetch('/builtin_schema/' + encodeURIComponent(m.id));
        if (!res.ok) throw new Error('HTTP ' + res.status);
        var schema = await res.json();
        layoutData = schema.layouts.map(function(l) {
          return {
            layout_index: l.layout_index,
            layout_name:  l.name,
            placeholders: (l.placeholders || []).map(function(p) {
              return { idx: p.idx, name: p.name, type: p.ph_type || 'BODY' };
            })
          };
        });
        statusEl.textContent = '\u2714 Đã tải ' + layoutData.length + ' layouts từ ' + m.name + '. Tiếp tục điền thông tin bên dưới.';
        statusEl.className = 'text-xs text-emerald-600';
        statusEl.classList.remove('hidden');
        document.getElementById('bStep2').classList.remove('hidden');
        document.getElementById('bStep3').classList.remove('hidden');
        document.getElementById('bStep4').classList.remove('hidden');
        document.getElementById('bStep5').classList.remove('hidden');
        document.getElementById('builtinOutlineInput').value = '';
        document.getElementById('builtinGenerateStatus').classList.add('hidden');
        document.getElementById('builtinDownloadLink').classList.add('hidden');
        document.getElementById('bStep2').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      } catch (e) {
        statusEl.textContent = '\u2715 Lỗi tải schema: ' + e.message;
        statusEl.className = 'text-xs text-red-500';
      }
    }

    /* ════════════════════════════════════════════════════════════════
       Init
    ════════════════════════════════════════════════════════════════ */
    document.addEventListener('DOMContentLoaded', function() {
      setMode('builtin');
    });
  </script>
</body>
</html>
